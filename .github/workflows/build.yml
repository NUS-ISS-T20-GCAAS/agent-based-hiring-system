name: Build Services

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated list of services to build (e.g., coordinator-agent,resume-intake-agent)'
        required: true
        default: 'coordinator-agent,resume-intake-agent'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Detect changed services (push / PR only)
      - name: Detect service changes
        uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          list-files: json
          filters: |
            coordinator-agent:
              - services/coordinator-agent/**
            resume-intake-agent:
              - services/resume-intake-agent/**
            screening-agent:
              - services/screening-agent/**
            ranking-agent:
              - services/ranking-agent/**
            audit-agent:
              - services/audit-agent/**

      # Decide final service list (SINGLE source of truth)
      - name: Set services list
        id: set-services
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"

            if [ -z "$SERVICES" ]; then
              echo "âŒ No services provided"
              exit 1
            fi

            JSON=$(printf '["%s"]' "${SERVICES//,/\",\"}")
            echo "services=$JSON" >> $GITHUB_OUTPUT

          else
            SERVICES='${{ steps.filter.outputs.changes }}'

            if [ "$SERVICES" = "[]" ] || [ -z "$SERVICES" ]; then
              echo "services=[]" >> $GITHUB_OUTPUT
            else
              echo "services=$SERVICES" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Debug services
        run: |
          echo "Services to build: ${{ steps.set-services.outputs.services }}"

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase repository name
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log build target
        run: |
          echo "Building service: ${{ matrix.service }}"

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ env.REPO_LOWER }}/${{ matrix.service }}:${{ github.sha }} \
            services/${{ matrix.service }}

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
            -u ${{ github.actor }} --password-stdin

      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ env.REPO_LOWER }}/${{ matrix.service }}:${{ github.sha }}
