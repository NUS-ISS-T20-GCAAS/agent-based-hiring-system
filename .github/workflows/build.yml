name: Build Services

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated list of services to build (e.g., coordinator-agent,resume-intake-agent)'
        required: true
        default: 'coordinator-agent,resume-intake-agent'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            coordinator-agent:
              - services/coordinator-agent/**
            resume-intake-agent:
              - services/resume-intake-agent/**
            screening-agent:
              - services/screening-agent/**
            ranking-agent:
              - services/ranking-agent/**
            audit-agent:
              - services/audit-agent/**

      - name: Set services
        id: services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Split the input services and format as JSON array
            SERVICES="${{ github.event.inputs.services }}"
            JSON_SERVICES=$(echo "$SERVICES" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "services=$JSON_SERVICES" >> $GITHUB_OUTPUT
          else
            echo "services=${{ steps.filter.outputs.changes }}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set lowercase repository name
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ env.REPO_LOWER }}/${{ matrix.service }}:${{ github.sha }} \
            services/${{ matrix.service }}

      - name: Push image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/${{ env.REPO_LOWER }}/${{ matrix.service }}:${{ github.sha }}
