name: Python CI/CD Pipeline

on:
  # 1. Automatic Build/Test on every push to main
  push:
    branches: [ "main" ]
  
  # 2. Manual Trigger for Deployment
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Select Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      confirmation:
        description: 'Type "DEPLOY" to proceed'
        required: true

jobs:
  # --- JOB 1: AUTOMATIC BUILD & TEST ---
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Tests
        run: |
          # Replace with 'pytest' when you have real tests
          echo "Running unit tests... All tests passed!"

  # --- JOB 2: MANUAL DEPLOYMENT ---
  deploy:
    name: Deploy to ${{ github.event.inputs.target_env }}
    needs: build-and-test
    # This job only runs if triggered manually AND confirmation matches
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirmation == 'DEPLOY'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Branch Safety Check
        if: github.event.inputs.target_env == 'prod' && github.ref != 'refs/heads/main'
        run: |
          echo "ERROR: You cannot deploy a non-main branch to Production!"
          exit 1

      - name: Load Environment Secrets
        run: |
          if [ "${{ github.event.inputs.target_env }}" == "prod" ]; then
            echo "TARGET_HOST=${{ secrets.PROD_HOST }}" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.target_env }}" == "staging" ]; then
            echo "TARGET_HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_ENV
          else
            echo "TARGET_HOST=${{ secrets.DEV_HOST }}" >> $GITHUB_ENV
          fi

      - name: Execute Dummy Deploy
        run: |
          echo "Deploying to: ${{ github.event.inputs.target_env }}"
          echo "Target Host: $TARGET_HOST"
          echo "Running deployment scripts..."
          echo "Success!"